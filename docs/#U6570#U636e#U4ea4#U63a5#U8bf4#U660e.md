# 数据交接说明（空气质量 + 气象特征）

## 1. 数据输出总览

| 文件路径 | 内容 | 备注 |
| --- | --- | --- |
| `dataset/data_merged.npz` | 统一数据张量 `x` (float32, 形状 `[35064, 341, 12]`) 与缺失掩码 `mask` (bool，同形状) | 已融合空气 6 项与气象 6 项特征，按时间×节点×特征排列 |
| `dataset/summary_merged.json` | 融合数据统计 | 含特征顺序、时间步数、节点数、原始来源路径 |
| `dataset/times.csv` | 时间轴 (北京时间) | 2016-01-01 00:00 ~ 2019-12-31 23:00，共 35,064 小时 |
| `dataset/nodes.csv` | 节点列表 | `node_id` 与城市名称（保留 341 个城市，按缺失率筛选） |
| `dataset/nodes_geo.csv` | 节点经纬度 | 每个城市的坐标与匹配策略，便于地图或空间建模 |
| `dataset/summary.json` | 空气张量统计 | 可回溯空气部分的缺失率、筛选阈值 |
| `dataset/pre_filter_stats.csv` / `dataset/node_stats.csv` | 缺失统计 | 提供筛选前后缺失率，为调参参考 |
| `meteo/meteo.npz` | 气象张量 `x_meteo` `[T, N, 6]` | 如需单独使用气象特征，可直接引用 |
| `meteo/summary.json` | 气象张量统计 | 记录气象特征缺失率与时间轴信息 |
| `meteo/raw/` | ERA5-Land 原始下载 | 每城每年对应的 zip 文件与下载日志 |
| `docs/方案说明.md` | 处理流程操作手册 | 包含从原始数据到最终融合数据的完整步骤 |

## 2. 特征说明

融合张量 `x` 的最后一维依次为：
1. `PM2.5`
2. `PM10`
3. `SO2`
4. `NO2`
5. `O3`
6. `CO`
7. `2m_dewpoint_temperature`
8. `2m_temperature`
9. `10m_u_component_of_wind`
10. `10m_v_component_of_wind`
11. `surface_pressure`
12. `total_precipitation`

缺失掩码 `mask` 使用布尔值表示原始数据缺失位置（`True` 表示该点曾缺失，模型可用作补值标记或损失屏蔽）。

## 3. 数据对齐与时区

- 时间轴使用北京时间，构建时已将 ERA5-Land 的 UTC 时间转换为 `Asia/Shanghai`。
- 空气与气象数据均对齐到相同时刻、相同节点顺序；在融合脚本中再次验证了时间/节点一致性。
- `dataset/times.csv` 提供所有时间戳（字符串格式），可用于数据重建或可视化。

## 4. 节点信息

- `dataset/nodes.csv`：`node_id` 自 0 至 340，对应城市中文名。
- `dataset/nodes_geo.csv`：提供经纬度、匹配的行政区名称、匹配策略（如 `exact-name-plus-市`、`special-map` 等）。
- 若需确认匹配准确性，可参考 `dataset/nodes_geo_ambiguous.csv`（仍保留多候选信息，但主文件已按优先级选择最合适的候选且确保坐标存在）。

## 5. 数据加载示例

```python
import numpy as np
import pandas as pd

data = np.load("dataset/data_merged.npz")
x = data["x"]        # float32, shape (35064, 341, 12)
mask = data["mask"]  # bool, same shape

times = pd.read_csv("dataset/times.csv", encoding="utf-8-sig")["datetime"]
nodes = pd.read_csv("dataset/nodes.csv", encoding="utf-8-sig").sort_values("node_id")

print(x.shape, mask.shape)  # (35064, 341, 12)
print(times.iloc[0], times.iloc[-1])  # 首末时间
print(nodes.head())                   # 城市清单
```

## 6. 模型训练建议

1. **特征预处理**：空气与气象特征量纲差异较大，建议分别做标准化或稳健缩放；`mask` 可作为缺失权重或补值指示。
2. **时间拆分**：如需划分训练/验证区间，可按时间轴进行切片（例如按年或按月份划分），以避免数据泄露。
3. **空间建模**：`nodes_geo.csv` 提供经纬度，可用于构建图结构或空间邻接矩阵。
4. **数据分批**：张量约 35k×341×12 ≈ 143M 浮点数（约 550 MB），如使用 GPU 训练，可按时间块或节点划分 mini-batch。
5. **扩展特征**：必要时可在加载后派生风速、风向等特征（如 `sqrt(u10^2 + v10^2)`），或通过外部数据补充更多天气指标。

## 7. 复现步骤（若需重新生成数据）

详见 `docs/方案说明.md`，核心命令顺序：
1. `python scripts/build_tensor.py …`
2. `python scripts/build_nodes_geo.py …`
3. `python qixiang/collect_nodes_era5.py …`
4. `python scripts/build_meteo_tensor.py …`
5. `python scripts/merge_air_meteo.py …`

如需仅在最新下载基础上更新张量，可从第 4 步或第 5 步开始，视改动范围而定。

## 8. 环境与依赖

- Python 3.8（`conda activate py38`）
- 主要依赖：`numpy`, `pandas`, `tqdm`, `cdsapi`
- 已启用 HTTP/HTTPS 代理 `127.0.0.1:7897` 用于 ERA5 下载；如环境变化，请相应调整。

## 9. 交付状态

- 空气、气象数据已全部下载并成功构建。
- 341 个节点无缺失的经纬度信息；缺失率较高或长期缺测的城市已过滤。
- 融合数据 `dataset/data_merged.npz` 可直接用于模型训练；如需单独使用空气或气象数据，可分别加载对应 `npz`。

如在使用过程中需要进一步说明或新增特征，请在此基础上补写处理脚本并更新文档。***
