# 交接文档（PM2.5 + GMAN_PDFusion 框架）

## 目标
- 帮助后续 AI/同事基于现有数据与脚手架，快速复现实验、添加新模型并做公平对比。
- 明确数据契约（输入/输出形状与预处理产物）、训练/评估命令、调参要点与显存注意事项。

---

## 目录结构（关键路径）
- 数据与产物
  - My/dataset/：融合数据（详见 My/docs/数据交接说明.md）
  - My/artifacts/：预处理结果
    - dtw_matrix.npy：DTW 距离矩阵
    - geo_mask.npy、sem_mask.npy：地理/语义掩码（[N,N] bool）
    - pattern_keys.npy：DFT 模式原型（[num_patterns, S, N]）
    - geo_neighbors.npz、sem_neighbors.npz：稀疏邻居（indices/alid）
- 代码与脚本
  - My/models/hybrid_gman_pdformer_pd.py：GMAN_PDFusion（混合空间注意力 + DFT，支持稀疏邻域）
  - My/models/gman_components.py：GMAN 基础模块（STEmbedding / temporal / transform / gated）
  - My/utils/data_pm25.py：PM2.5 数据加载与划分（Train/Val/Test），标准化、时间特征编码
  - My/utils/dtw.py、My/utils/masks.py、My/utils/patterns.py：预处理工具
  - My/scripts/train_pm25.py：训练脚本（AMP、best checkpoint、可自动测试）
  - My/scripts/test_pm25.py：加载 checkpoint 在测试集评估
  - My/scripts/evaluate.py：快速对比（不加载权重）GMAN_PDFusion/MLP/GCN 的前向指标
  - My/docs/训练评估说明.md：训练/评估流程说明

---

## 数据契约（务必遵守）
- X/y：形状 [B, T, N]，目标维由 eature_idx 指定（默认 PM2.5=0）
- TE：形状 [B, T, 2]，[day_of_week, time_of_day_index]，每日 24 个时间步
- GMAN_PDFusion 前向：orward(X, TE) -> [B, num_pred, N]
- 预处理产物路径（可在 YAML 修改）：
  - pattern_path、geo_mask_path、sem_mask_path
  - 稀疏注意力时使用：geo_neighbors_path、sem_neighbors_path

---

## 环境与依赖
- Python 3.8+
- pip install torch numpy pandas scikit-learn pyyaml
- GPU 训练默认启用 AMP（混合精度），可显著降低显存占用

---

## 预处理步骤（一次性）
1) DTW 距离矩阵：
`ash
python My/utils/dtw.py \
  --data-dir My/dataset \
  --downsample 168 \
  --radius-ratio 0.05 \
  --cache-path My/artifacts/dtw_matrix.npy
`
2) 地理/语义掩码：
`ash
python - <<'PY'
import numpy as np
import pandas as pd
from My.utils.masks import build_geographic_mask, build_semantic_mask
coords = pd.read_csv('My/dataset/nodes_geo.csv', encoding='utf-8-sig')[['lat','lon']].to_numpy()
geo_mask = build_geographic_mask(coords=coords, threshold=300)  # 300 km 内邻居
np.save('My/artifacts/geo_mask.npy', geo_mask)
dtw = np.load('My/artifacts/dtw_matrix.npy')
sem_mask = build_semantic_mask(dtw, topk=8)
np.save('My/artifacts/sem_mask.npy', sem_mask)
PY
`
3) DFT 模式原型：
`ash
python - <<'PY'
from pathlib import Path
from My.utils.patterns import learn_delay_patterns_from_dataset
learn_delay_patterns_from_dataset(
    Path('My/dataset'), window=6, num_patterns=16, stride=6, normalize=True,
    cache_path=Path('My/artifacts/pattern_keys.npy'),
)
PY
`
4) 稀疏邻居索引（稀疏注意力需要）：
`ash
python - <<'PY'
import numpy as np
from pathlib import Path
from My.utils.masks import mask_to_neighbor_indices
geo_mask = np.load('My/artifacts/geo_mask.npy')
sem_mask = np.load('My/artifacts/sem_mask.npy')
mask_to_neighbor_indices(geo_mask, include_self=True, cache_path=Path('My/artifacts/geo_neighbors.npz'))
mask_to_neighbor_indices(sem_mask, include_self=True, cache_path=Path('My/artifacts/sem_neighbors.npz'))
PY
`

---

## 配置（My/config/pm25.yaml）
- 数据：
um_pred=12，history_len=24，atch_size=16，eature_idx=0
- 优化：learning_rate=5e-4，epochs=50
- 模型：K=8，d=8，L=3，geo_ratio=0.6，S=6，
um_patterns=16
- 时间步：	ime_steps_per_day=24；显存：spatial_chunk_size=64
- 路径：pattern_path、geo_mask_path、sem_mask_path、geo_neighbors_path、sem_neighbors_path

---

## 训练与测试
- 训练（CUDA/AMP，结束自动测试）：
`ash
python My/scripts/train_pm25.py \
  --config My/config/pm25.yaml \
  --device cuda \
  --run-test
`
- 调试（限制步数）：
`ash
python My/scripts/train_pm25.py \
  --config My/config/pm25.yaml \
  --device cuda \
  --max-train-steps 100 \
  --max-val-steps 20
`
- 单独测试（加载最佳权重）：
`ash
python My/scripts/test_pm25.py \
  --config My/config/pm25.yaml \
  --checkpoint My/results/runs/<timestamp>/best_model.pt \
  --device cuda
`

---

## 显存与训练建议
- 稀疏注意力已接入，仅对邻居做注意力；但 Q/K/V 仍为 [B,K,T,N,d] 的密集张量，是显存主要来源。
- 若显存紧张：
  - 优先降低 atch_size（如 16→8/4）、缩短 history_len、减小 K 或 geo_ratio；
  - 增大 spatial_chunk_size（更快但略增占用）或使用梯度检查点；
  - 保持 AMP 开启。

---

## 如何接入其他模型做对比
- 基础数据加载：
  - 使用 My/utils/data_pm25.py：load_pm25_dataloaders(PM25DatasetConfig) 获取 Train/Val/Test DataLoader；
  - 统一使用 X / TE / y / mask_y 字段与指标函数（My/utils/metrics.py）。
- 新模型接口规范：
  - 在 My/models/ 新建文件，暴露 class MyModel(nn.Module): forward(X, TE) -> [B, Q, N]；
  - 若不需要时空嵌入，可忽略 TE，但确保输出形状一致，便于评测对齐。
- 训练/评估脚手架：
  - 训练可拷贝 My/scripts/train_pm25.py，替换模型构造与损失；保留 AMP 与日志。
  - 评估可在 My/scripts/evaluate.py 的 
un_eval 中注册你的模型分支。
- 稀疏/图信息复用：
  - 需要图结构时，直接读取 geo_mask.npy、geo_neighbors.npz（或构建稀疏张量）。

---

## 复现与日志
- 日志：My/results/runs/<timestamp>/train.log（train/val/test 指标）
- 配置：My/results/runs/<timestamp>/config.json
- 权重：est_model.pt（模型/优化器/AMP 状态）

---

## 常见问题
- **AMP 兼容**：脚本动态检测 GradScaler/autocast 签名，兼容旧版本。
- **稀疏仍吃显存**：Q/K/V/DFT 激活仍为密集张量；可降 atch_size/K/history_len 或引入检查点。
- **邻居填充值**：mask_to_neighbor_indices 返回 alid 掩码，softmax 前对无效位置置 -inf，不影响权重。

---

## 后续工作建议
- 深度稀疏化：将 K/V 也按邻居切片（CSR/segment 操作），进一步降低显存。
- 统一评测 CLI：将 evaluate.py 抽象为“模型注册表 + 统一 runner”，便于批量跑实验。

